<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha de Custos da Obra (com Firebase)</title>
    <!-- Carrega o framework de estilo Tailwind CSS para um design rápido e moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte 'Inter' do Google Fonts para uma melhor legibilidade -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Carrega a biblioteca de ícones 'Lucide' -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom-color: #3b82f6; font-weight: 600; }
        .tab { border-bottom-color: transparent; }
        .content-section { display: none; }
        .content-active { display: block; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        .spinner { border: 2px solid #fff; border-top-color: transparent; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Controle de Custos da Construção</h1>
                <p class="text-gray-500 mt-1">Dados salvos na nuvem e sincronizados em tempo real.</p>
            </div>
            <div id="add-item-button-container" class="mt-4 md:mt-0"></div>
        </div>

        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-4 -mb-px overflow-x-auto" aria-label="Tabs">
                <button data-tab="resumo" onclick="window.App.changeTab('resumo')" class="tab tab-active text-blue-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Resumo Geral</button>
                <button data-tab="materiais" onclick="window.App.changeTab('materiais')" class="tab text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Materiais</button>
                <button data-tab="mao-de-obra" onclick="window.App.changeTab('mao-de-obra')" class="tab text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Mão de Obra</button>
                <button data-tab="outros-custos" onclick="window.App.changeTab('outros-custos')" class="tab text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Outros Custos</button>
            </nav>
        </div>

        <div id="content">
            <!-- Resumo Geral: O painel principal que mostra os totais da obra -->
            <div id="resumo-content" class="content-section content-active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg"><h3 class="text-sm font-medium text-blue-800 uppercase">Custo Total da Obra</h3><p id="total-real" class="mt-2 text-4xl font-bold text-blue-900">R$ 0,00</p><p id="total-previsto" class="text-sm text-blue-700 mt-1">Previsto: R$ 0,00</p></div>
                    <div id="diferenca-card" class="bg-gray-50 border-l-4 border-gray-500 p-6 rounded-lg"><h3 class="text-sm font-medium text-gray-800 uppercase">Diferença</h3><p id="diferenca-valor" class="mt-2 text-4xl font-bold text-gray-900">R$ 0,00</p><p id="diferenca-status" class="text-sm text-gray-700 mt-1">Planejado vs. Real</p></div>
                    <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg"><h3 class="text-sm font-medium text-green-800 uppercase">Progresso do Orçamento</h3><div class="w-full bg-green-200 rounded-full h-4 mt-3"><div id="progresso-barra" class="bg-green-600 h-4 rounded-full" style="width: 0%"></div></div><p id="progresso-texto" class="text-sm text-green-700 mt-2 text-center">0% do orçamento previsto utilizado.</p></div>
                </div>
                <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg"><h4 class="font-semibold text-gray-700">Materiais</h4><p id="materiais-total-real" class="text-2xl font-bold text-gray-900 mt-2">R$ 0,00</p><p id="materiais-total-previsto" class="text-sm text-gray-500">Previsto: R$ 0,00</p></div>
                    <div class="bg-gray-50 p-6 rounded-lg"><h4 class="font-semibold text-gray-700">Mão de Obra</h4><p id="mao-de-obra-total-real" class="text-2xl font-bold text-gray-900 mt-2">R$ 0,00</p><p id="mao-de-obra-total-previsto" class="text-sm text-gray-500">Previsto: R$ 0,00</p></div>
                    <div class="bg-gray-50 p-6 rounded-lg"><h4 class="font-semibold text-gray-700">Outros Custos</h4><p id="outros-custos-total-real" class="text-2xl font-bold text-gray-900 mt-2">R$ 0,00</p><p id="outros-custos-total-previsto" class="text-sm text-gray-500">Previsto: R$ 0,00</p></div>
                </div>
            </div>

            <!-- Seções de Conteúdo das Abas -->
            <div id="materiais-content" class="content-section"></div>
            <div id="mao-de-obra-content" class="content-section"></div>
            <div id="outros-custos-content" class="content-section"></div>
        </div>
    </div>

    <!-- Modais (Janelas Pop-up) -->
    <div id="item-modal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop fixed inset-0" onclick="window.App.closeModal()"></div><div class="bg-white rounded-lg shadow-xl m-4 sm:max-w-lg w-full z-10"><div class="p-6"><div class="flex justify-between items-center"><h3 id="modal-title" class="text-xl font-semibold text-gray-800">Adicionar Item</h3><button onclick="window.App.closeModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button></div><form id="item-form" class="mt-4 space-y-4"></form></div></div></div>
    <div id="confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden"><div class="modal-backdrop fixed inset-0" onclick="window.App.closeConfirmModal()"></div><div class="bg-white rounded-lg shadow-xl m-4 sm:max-w-md w-full z-10">
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
            <h3 id="confirm-modal-title" class="text-lg leading-6 font-medium text-gray-900">Excluir Item</h3>
            <button onclick="window.App.closeConfirmModal()" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="p-6">
            <div class="flex items-start">
                <div class="flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-full bg-red-100 sm:mx-0">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <div class="mt-1 sm:ml-4 sm:text-left">
                    <p id="confirm-modal-text" class="text-sm text-gray-500">Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
            <button id="confirm-delete-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Excluir</button>
            <button id="cancel-delete-btn" onclick="window.App.closeConfirmModal()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Cancelar</button>
        </div>
    </div></div>

    <script type="module">
        // =================================================================================
        // SEÇÃO 1: CONFIGURAÇÃO E CONEXÃO COM O FIREBASE
        // =================================================================================

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, where, getDocs, setDoc
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Objeto de configuração do seu projeto Firebase.
        const firebaseConfig = {
            apiKey: "AIzaSyCdydUpJpJo-IvdkCKhKvAtUDHeEu-giMc",
            authDomain: "obra-dos-meus-pais-teste.firebaseapp.com",
            projectId: "obra-dos-meus-pais-teste",
            storageBucket: "obra-dos-meus-pais-teste.firebasestorage.app",
            messagingSenderId: "100940051405",
            appId: "1:100940051405:web:f69664404d4264b8bdca84"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // =================================================================================
        // SEÇÃO 2: ESTADO DA APLICAÇÃO
        // =================================================================================
        
        let data = { 
            materiais: [], 
            servicos: [],
            pagamentos: [],
            "outros-custos": [],
            orcamentos: {} 
        };
        let activeTab = 'resumo';
        let editingItemId = null;
        let currentModalContext = {};

        // =================================================================================
        // SEÇÃO 3: FUNÇÕES DE UTILIDADE
        // =================================================================================

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        
        // =================================================================================
        // SEÇÃO 4: FUNÇÕES DE RENDERIZAÇÃO (Construção da Interface)
        // =================================================================================

        function createTableStructure(title, headers, bodyId) {
            return `<div class="bg-white rounded-lg overflow-hidden mt-8"><h2 class="text-xl font-semibold text-gray-700 p-4">${title}</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>${headers.map(h => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}<th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th></tr></thead><tbody id="${bodyId}" class="bg-white divide-y divide-gray-200"><tr id="${bodyId}-loader"><td colspan="${headers.length + 1}"><div class="loader"></div></td></tr></tbody></table></div></div>`;
        }

        function createBudgetCard(title, categoryId, totalGasto, orcamento) {
            const restante = orcamento - totalGasto;
            const progresso = orcamento > 0 ? (totalGasto / orcamento) * 100 : 0;

            let progressColor = 'bg-blue-600';
            if (progresso > 100) progressColor = 'bg-red-600';
            else if (progresso > 75) progressColor = 'bg-yellow-500';
            
            return `
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 mb-8">
                    <h3 class="text-lg font-bold text-gray-800">${title}</h3>
                    <div class="mt-2">
                        <label for="${categoryId}-budget" class="text-sm font-medium text-gray-700">Definir Orçamento Total</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">R$</span>
                            <input type="number" id="${categoryId}-budget" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" value="${orcamento || ''}" placeholder="50000.00">
                            <button onclick="window.App.saveOrcamento('${categoryId}')" class="inline-flex items-center px-4 py-2 border border-l-0 border-blue-600 rounded-r-md bg-blue-600 text-white hover:bg-blue-700">Salvar</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="${progressColor} h-4 rounded-full" style="width: ${Math.min(progresso, 100)}%;"></div>
                        </div>
                        <div class="flex justify-between text-sm mt-2">
                            <span class="font-medium text-gray-600">Progresso (${progresso.toFixed(0)}%)</span>
                            <span class="font-bold text-gray-800">${formatCurrency(totalGasto)} / ${formatCurrency(orcamento)}</span>
                        </div>
                        <p class="text-right text-xs ${restante >= 0 ? 'text-green-600' : 'text-red-600'} font-medium mt-1">
                            ${restante >= 0 ? 'Restante: ' : 'Excedido: '} ${formatCurrency(Math.abs(restante))}
                        </p>
                    </div>
                </div>
            `;
        }
        
        function renderMateriaisUI() {
            const container = document.getElementById('materiais-content');
            if(!container) return;

            const totalGasto = data.materiais.reduce((acc, item) => acc + (item.custoReal || 0), 0);
            const orcamento = data.orcamentos.materiais || 0;
            
            const budgetCardHtml = createBudgetCard('Orçamento de Materiais', 'materiais', totalGasto, orcamento);
            const tableHtml = createTableStructure('Histórico de Compras', ['Etapa', 'Item', 'Custo Real', 'Fornecedor', 'Data'], 'materiais-body');
            container.innerHTML = budgetCardHtml + tableHtml;

            const tbody = document.getElementById('materiais-body');
            tbody.innerHTML = data.materiais.map(item => `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.etapa || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.item || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrency(item.custoReal)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.fornecedor || '-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.data || '-'}</td>${App.createActionsCell('materiais', item.id)}</tr>`).join('');
        }
        
        function renderMaoDeObraUI() {
            const container = document.getElementById('mao-de-obra-content');
            if (!container) return;

            let contractsHtml = '<div class="space-y-6">';
            if (data.servicos.length === 0) {
                 contractsHtml += `<div class="text-center py-12 px-6 bg-gray-50 rounded-lg"><p class="text-gray-500">Nenhum contrato de serviço adicionado.</p><p class="text-sm text-gray-400 mt-1">Comece adicionando um contrato para acompanhar as metas.</p></div>`;
            }

            data.servicos.forEach(servico => {
                const pagamentosDoServico = data.pagamentos.filter(p => p.servicoId === servico.id);
                const totalPago = pagamentosDoServico.reduce((acc, p) => acc + (p.valor || 0), 0);
                const valorMeta = servico.valorMeta || 0;
                const restante = valorMeta - totalPago;
                const progresso = valorMeta > 0 ? (totalPago / valorMeta) * 100 : 0;

                let progressColor = 'bg-blue-600';
                if (progresso > 100) progressColor = 'bg-red-600';
                else if (progresso > 75) progressColor = 'bg-yellow-500';

                contractsHtml += `
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${servico.nome}</h3>
                                <p class="text-sm text-gray-500">${servico.profissional}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="window.App.openModal('servico', '${servico.id}')" class="text-gray-400 hover:text-blue-600 p-1 rounded-full"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="window.App.deleteItem('servico', '${servico.id}')" class="text-gray-400 hover:text-red-600 p-1 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-4"><div class="${progressColor} h-4 rounded-full" style="width: ${Math.min(progresso, 100)}%;"></div></div>
                            <div class="flex justify-between text-sm mt-2"><span class="font-medium text-gray-600">Progresso (${progresso.toFixed(0)}%)</span><span class="font-bold text-gray-800">${formatCurrency(totalPago)} / ${formatCurrency(valorMeta)}</span></div>
                            <p class="text-right text-xs ${restante >= 0 ? 'text-green-600' : 'text-red-600'} font-medium mt-1">${restante >= 0 ? 'Restante: ' : 'Excedido: '} ${formatCurrency(Math.abs(restante))}</p>
                        </div>
                        <div class="mt-4 border-t pt-4"><button onclick="window.App.openModal('pagamento', null, { servicoId: '${servico.id}' })" class="w-full text-center bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">Adicionar Pagamento</button></div>
                    </div>`;
            });
            contractsHtml += '</div>';

            const paymentsTableHtml = createTableStructure('Histórico de Pagamentos', ['Data', 'Descrição', 'Valor', 'Contrato Vinculado'], 'pagamentos-body');
            container.innerHTML = contractsHtml + '<div class="mt-12">' + paymentsTableHtml + '</div>';
            
            const tbodyPagamentos = document.getElementById('pagamentos-body');
            document.getElementById('pagamentos-body-loader')?.remove();
            tbodyPagamentos.innerHTML = data.pagamentos.map(p => {
                const servicoAssociado = data.servicos.find(s => s.id === p.servicoId);
                return `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.data || '-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.descricao || 'Pagamento'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${formatCurrency(p.valor)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${servicoAssociado?.nome || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="window.App.openModal('pagamento', '${p.id}', { servicoId: '${p.servicoId}' })" class="text-gray-400 hover:text-blue-600 p-1 rounded-full"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="window.App.deleteItem('pagamento', '${p.id}')" class="text-gray-400 hover:text-red-600 p-1 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`
            }).join('');
        }

        function renderOutrosCustosUI() {
            const container = document.getElementById('outros-custos-content');
            if(!container) return;

            const totalGasto = data['outros-custos'].reduce((acc, item) => acc + (item.valorPago || 0), 0);
            const orcamento = data.orcamentos['outros-custos'] || 0;

            const budgetCardHtml = createBudgetCard('Orçamento de Outros Custos', 'outros-custos', totalGasto, orcamento);
            const tableHtml = createTableStructure('Histórico de Outros Custos', ['Tipo de Custo', 'Descrição', 'Valor Pago', 'Data'], 'outros-custos-body');
            container.innerHTML = budgetCardHtml + tableHtml;
            
            const tbody = document.getElementById('outros-custos-body');
            tbody.innerHTML = data['outros-custos'].map(item => `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.tipo || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.descricao || ''}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${formatCurrency(item.valorPago)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.data || '-'}</td>${App.createActionsCell('outros-custos', item.id)}</tr>`).join('');
        }

        function updateSummary() {
            const sum = (arr, key) => arr.reduce((acc, item) => acc + (parseFloat(item[key]) || 0), 0);
            
            const materiaisReal = sum(data.materiais, 'custoReal');
            const maoDeObraReal = sum(data.pagamentos, 'valor');
            const outrosReal = sum(data['outros-custos'], 'valorPago');
            
            const materiaisPrevisto = data.orcamentos.materiais || 0;
            const maoDeObraPrevisto = sum(data.servicos, 'valorMeta');
            const outrosPrevisto = data.orcamentos['outros-custos'] || 0;

            const totalPrevisto = materiaisPrevisto + maoDeObraPrevisto + outrosPrevisto;
            const totalReal = materiaisReal + maoDeObraReal + outrosReal;
            const diferenca = totalPrevisto - totalReal;

            document.getElementById('materiais-total-real').textContent = formatCurrency(materiaisReal);
            document.getElementById('materiais-total-previsto').textContent = `Previsto: ${formatCurrency(materiaisPrevisto)}`;
            document.getElementById('mao-de-obra-total-real').textContent = formatCurrency(maoDeObraReal);
            document.getElementById('mao-de-obra-total-previsto').textContent = `Previsto: ${formatCurrency(maoDeObraPrevisto)}`;
            document.getElementById('outros-custos-total-real').textContent = formatCurrency(outrosReal);
            document.getElementById('outros-custos-total-previsto').textContent = `Previsto: ${formatCurrency(outrosPrevisto)}`;
            
            document.getElementById('total-real').textContent = formatCurrency(totalReal);
            document.getElementById('total-previsto').textContent = `Previsto: ${formatCurrency(totalPrevisto)}`;
            document.getElementById('diferenca-valor').textContent = formatCurrency(diferenca);
            
            const diferencaCard = document.getElementById('diferenca-card');
            diferencaCard.className = 'p-6 rounded-lg';
            if (diferenca < 0) {
                diferencaCard.classList.add('bg-red-50', 'border-l-4', 'border-red-500');
                diferencaCard.querySelector('#diferenca-status').textContent = `Acima do planejado`;
            } else {
                diferencaCard.classList.add('bg-green-50', 'border-l-4', 'border-green-500');
                diferencaCard.querySelector('#diferenca-status').textContent = `Abaixo do planejado`;
            }
            const progresso = totalPrevisto > 0 ? (totalReal / totalPrevisto) * 100 : 0;
            document.getElementById('progresso-barra').style.width = `${Math.min(progresso, 100)}%`;
            document.getElementById('progresso-texto').textContent = `${progresso.toFixed(0)}% do orçamento previsto utilizado.`;
            
            lucide.createIcons();
        }
        
        // =================================================================================
        // SEÇÃO 5: O OBJETO 'APP' (O Coração da Aplicação)
        // =================================================================================
        
        const App = {
            createActionsCell(category, id) {
                return `<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="window.App.openModal('${category}', '${id}')" class="text-gray-400 hover:text-blue-600 p-1 rounded-full"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="window.App.deleteItem('${category}', '${id}')" class="text-gray-400 hover:text-red-600 p-1 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>`;
            },
            changeTab(tabName) {
                activeTab = tabName;
                document.querySelectorAll('.tab').forEach(tab => {
                    const isCurrentTab = tab.dataset.tab === tabName;
                    tab.classList.toggle('tab-active', isCurrentTab);
                    tab.classList.toggle('text-blue-500', isCurrentTab);
                    tab.classList.toggle('text-gray-500', !isCurrentTab);
                });

                document.querySelectorAll('.content-section').forEach(content => {
                    const isCurrentContent = content.id === `${tabName}-content`;
                    content.classList.toggle('content-active', isCurrentContent);
                });
                
                this.updateAddItemButton();
            },
            updateAddItemButton() {
                const container = document.getElementById('add-item-button-container');
                if (activeTab === 'resumo' || activeTab === 'mao-de-obra') {
                    container.innerHTML = '';
                     if (activeTab === 'mao-de-obra') {
                         container.innerHTML = `<button onclick="window.App.openModal('servico')" class="flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i data-lucide="plus" class="w-5 h-5 mr-2"></i>Adicionar Contrato</button>`;
                     }
                } else {
                     const categoryMap = { 
                        materiais: { name: 'Material', type: 'materiais' }, 
                        'outros-custos': { name: 'Outro Custo', type: 'outros-custos' }
                    };
                    const currentCategory = categoryMap[activeTab];
                    container.innerHTML = `<button onclick="window.App.openModal('${currentCategory.type}')" class="flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors"><i data-lucide="plus" class="w-5 h-5 mr-2"></i>Adicionar ${currentCategory.name}</button>`;
                }
                
                lucide.createIcons();
            },
            openModal(type, id = null, context = {}) {
                editingItemId = id;
                currentModalContext = context;
                const form = document.getElementById('item-form');
                const modalTitle = document.getElementById('modal-title');
                let item = {};
                
                const collectionName = type === 'pagamento' ? 'pagamentos' : (type === 'servico' ? 'servicos' : type);
                if (id) {
                    item = data[collectionName]?.find(i => i.id === id) || {};
                }

                modalTitle.textContent = (id ? 'Editar ' : 'Adicionar ') + 
                    {servico: 'Contrato de Serviço', pagamento: 'Pagamento', materiais: 'Material', 'outros-custos': 'Outro Custo'}[type];

                form.innerHTML = this.getFormFields(type, item);
                form.onsubmit = (e) => this.saveItem(e, type);
                document.getElementById('item-modal').classList.remove('hidden');
                document.getElementById('item-modal').classList.add('flex');
                lucide.createIcons();
            },
            closeModal() {
                document.getElementById('item-modal').classList.add('hidden');
                document.getElementById('item-modal').classList.remove('flex');
                editingItemId = null;
                currentModalContext = {};
            },
            getFormFields(type, item = {}) {
                const createField = (label, id, inputType = 'text', value = '', props = '') => `<div><label for="${id}" class="block text-sm font-medium text-gray-700">${label}</label><input type="${inputType}" id="${id}" name="${id}" value="${value}" ${props} class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>`;
                let fields = '';
                switch (type) {
                    case 'materiais': fields = `${createField('Etapa da Obra', 'etapa', 'text', item.etapa || '')}${createField('Item', 'item', 'text', item.item || '')}${createField('Custo Real', 'custoReal', 'number', item.custoReal || '', 'step="0.01"')}${createField('Fornecedor', 'fornecedor', 'text', item.fornecedor || '')}${createField('Data da Compra', 'data', 'date', item.data || '')}`; break;
                    case 'servico': fields = `${createField('Nome do Serviço (Contrato)', 'nome', 'text', item.nome || '')}${createField('Profissional/Empresa', 'profissional', 'text', item.profissional || '')}${createField('Valor Meta (Total)', 'valorMeta', 'number', item.valorMeta || '', 'step="0.01"')}`; break;
                    case 'pagamento': fields = `${createField('Descrição do Pagamento', 'descricao', 'text', item.descricao || '')}${createField('Valor Pago', 'valor', 'number', item.valor || '', 'step="0.01"')}${createField('Data do Pagamento', 'data', 'date', item.data || '')}`; break;
                    case 'outros-custos': fields = `${createField('Tipo de Custo', 'tipo', 'text', item.tipo || '')}${createField('Descrição', 'descricao', 'text', item.descricao || '')}${createField('Valor Pago', 'valorPago', 'number', item.valorPago || '', 'step="0.01"')}${createField('Data do Pagamento', 'data', 'date', item.data || '')}`; break;
                }
                return fields + `<div class="pt-2 flex justify-end space-x-3"><button type="button" onclick="window.App.closeModal()" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">Cancelar</button><button id="save-form-btn" type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">Salvar</button></div>`;
            },
            showConfirmModal(title, text, onConfirmCallback) {
                document.getElementById('confirm-modal-title').textContent = title;
                document.getElementById('confirm-modal-text').textContent = text;
                const modal = document.getElementById('confirm-modal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                const confirmBtn = document.getElementById('confirm-delete-btn');
                const cancelBtn = document.getElementById('cancel-delete-btn');
                
                confirmBtn.disabled = false;
                cancelBtn.disabled = false;
                confirmBtn.innerHTML = 'Excluir';

                confirmBtn.onclick = () => onConfirmCallback(confirmBtn, cancelBtn);
                
                lucide.createIcons();
            },
            closeConfirmModal() {
                document.getElementById('confirm-modal').classList.add('hidden');
                document.getElementById('confirm-modal').classList.remove('flex');
            },
            async saveItem(event, type) {
                event.preventDefault();
                const saveButton = event.target.querySelector('button[type="submit"]');
                if (!saveButton) return;

                const originalButtonHTML = saveButton.innerHTML;
                saveButton.disabled = true;
                saveButton.innerHTML = `<div class="w-5 h-5 border-2 border-white spinner rounded-full animate-spin mx-auto"></div>`;

                const formData = new FormData(event.target);
                const newItemData = Object.fromEntries(formData.entries());
                
                Object.keys(newItemData).forEach(key => {
                    if (['custoReal', 'valorMeta', 'valor', 'valorPago'].includes(key)) {
                        newItemData[key] = parseFloat(newItemData[key]) || 0;
                    }
                });

                if (type === 'pagamento' && currentModalContext.servicoId) {
                    newItemData.servicoId = currentModalContext.servicoId;
                }

                const collectionName = type === 'pagamento' ? 'pagamentos' : (type === 'servico' ? 'servicos' : type);

                try {
                    if (editingItemId) {
                        await updateDoc(doc(db, collectionName, editingItemId), newItemData);
                    } else {
                        await addDoc(collection(db, collectionName), newItemData);
                    }
                    this.closeModal();
                } catch (e) {
                    console.error("Erro ao salvar documento: ", e);
                    alert("Ocorreu um erro ao salvar. Verifique o console para mais detalhes.");
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalButtonHTML;
                }
            },
            async saveOrcamento(categoryId) {
                const input = document.getElementById(`${categoryId}-budget`);
                const button = input.nextElementSibling;
                const originalButtonHTML = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<div class="w-5 h-5 border-2 border-white spinner rounded-full animate-spin mx-auto"></div>`;

                const valorMeta = parseFloat(input.value) || 0;
                try {
                    await setDoc(doc(db, "orcamentos", categoryId), { valorMeta }, { merge: true });
                } catch (e) {
                    console.error("Erro ao salvar orçamento: ", e);
                    alert("Ocorreu um erro ao salvar o orçamento.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalButtonHTML;
                }
            },
            async deleteItem(type, id) {
                const collectionName = type === 'pagamento' ? 'pagamentos' : (type === 'servico' ? 'servicos' : type);
                
                let title = 'Excluir Item';
                let text = 'Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.';

                if (type === 'servico') {
                    title = 'Excluir Contrato de Serviço?';
                    text = 'Isso irá excluir o contrato e TODOS os pagamentos vinculados a ele. Esta ação é irreversível.';
                }

                this.showConfirmModal(title, text, async (confirmButton, cancelButton) => {
                    const originalButtonText = confirmButton.innerHTML;
                    confirmButton.disabled = true;
                    cancelButton.disabled = true;
                    confirmButton.innerHTML = `<div class="w-5 h-5 border-2 border-white spinner rounded-full animate-spin mx-auto"></div>`;

                    try {
                        if (type === 'servico') {
                            const q = query(collection(db, "pagamentos"), where("servicoId", "==", id));
                            const querySnapshot = await getDocs(q);
                            const deletePromises = [];
                            querySnapshot.forEach((doc) => {
                                deletePromises.push(deleteDoc(doc.ref));
                            });
                            await Promise.all(deletePromises);
                        }

                        await deleteDoc(doc(db, collectionName, id));
                        this.closeConfirmModal();
                    } catch (e) {
                        console.error("Erro ao deletar documento: ", e);
                        alert("Ocorreu um erro ao deletar.");
                        confirmButton.disabled = false;
                        cancelButton.disabled = false;
                        confirmButton.innerHTML = originalButtonText;
                    }
                });
            },
            
            init() {
                onSnapshot(collection(db, 'materiais'), (snapshot) => {
                    data.materiais = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    this.renderAll();
                });
                onSnapshot(collection(db, 'servicos'), (snapshot) => {
                    data.servicos = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    this.renderAll();
                });
                onSnapshot(collection(db, 'pagamentos'), (snapshot) => {
                    data.pagamentos = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    this.renderAll();
                });
                onSnapshot(collection(db, 'outros-custos'), (snapshot) => {
                    data['outros-custos'] = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    this.renderAll();
                });
                onSnapshot(collection(db, 'orcamentos'), (snapshot) => {
                    data.orcamentos = {};
                    snapshot.forEach(doc => {
                        data.orcamentos[doc.id] = doc.data().valorMeta;
                    });
                    this.renderAll();
                });
                
                this.changeTab('resumo');
            },

            renderAll() {
                renderMateriaisUI();
                renderMaoDeObraUI();
                renderOutrosCustosUI();
                updateSummary();
                lucide.createIcons();
            }
        };

        window.App = App;
        
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
